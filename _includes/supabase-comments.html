<style>
/* 评论表单容器和评论列表容器宽度100% */
#supabase-comments .comment-form-container,
#supabase-comments .comment-list {
  width: 100%;
}

/* 针对文本输入框(textarea)的宽度设置 */
#comment-form textarea {
  width: 100%; /* 设置宽度为100% */
  box-sizing: border-box; /* 重要的设置：确保padding和border包含在宽度内，避免溢出 */
  min-height: 100px; /* 设置一个最小高度 */
  padding: 10px; /* 内边距，根据喜好调整 */
  font-family: inherit; /* 继承父元素的字体 */
  font-size: 1em; /* 继承父元素的字体大小 */
  border: 1px solid #ddd; /* 边框样式 */
  border-radius: 4px; /* 圆角 */
  resize: vertical; /* 允许用户垂直调整大小 */
}

/* 提交按钮的样式，可根据需要调整 */
#comment-form button[type="submit"] {
  margin-top: 10px;
  padding: 8px 16px;
  background-color: #3b82f6; /* 示例颜色 */
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
</style>

<section id="supabase-comments" class="comments">
  <!-- 您的评论表单和评论列表HTML结构在这里 -->
  <form id="comment-form" class="comment-form-container">
    <textarea name="content" placeholder="留下您的评论..." required></textarea>
    <button type="submit">提交评论</button>
  </form>
  <ul id="comment-list" class="comment-list">
    <!-- 评论将动态加载在这里 -->
    
  </ul>
</section>

<script>
// 初始化 Supabase 客户端
const supabaseUrl = {{ site.supabase.url }};
const supabaseKey = {{ site.supabase.key }};
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// 获取当前页面的唯一标识（例如文章Slug）
const currentPageSlug = '{{ page.url }}'; // 使用Jekyll模板变量

// 加载现有评论
// IP地址脱敏函数
function desensitizeIP(ip) {
  // 检查是否是有效的IPv4地址
  const ipParts = ip.split('.');
  if (ipParts.length === 4) {
    // 将IP地址的第二段和第三段替换为星号，例如 "192.168.1.1" -> "192.*.*.1"
    return `${ipParts[0]}.*.*.${ipParts[3]}`;
  }
  // 如果不是标准IPv4，返回原值或未知
  return ip === 'Unknown' ? ip : 'IP Invalid';
}

// 在加载和显示评论的函数中
async function loadComments() {
  const { data: comments, error } = await supabase
    .from('comments')
    .select('*')
    .eq('post_slug', currentPageSlug)
    .order('created_at', { ascending: false });

  if (error) {
    console.error('Error loading comments:', error);
    return;
  }

  const commentList = document.getElementById('comment-list');
  commentList.innerHTML = comments.map(comment => `
    <li>
      <strong>${comment.author_name}</strong>
      <time>${new Date(comment.created_at).toLocaleString()}</time>
      <!-- 显示脱敏后的IP -->
      <span class="comment-ip">[${desensitizeIP(comment.commenter_ip)}]</span>
      <p>${comment.content}</p>
    </li>
  `).join('');
}

// 提交新评论
document.getElementById('comment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = e.target.content.value.trim();
    let commenterIP = '';
    try {
      const ipResponse = await fetch('https://api.ipify.org?format=json');
      const ipData = await ipResponse.json();
      commenterIP = ipData.ip;
    } catch (error) {
      console.error("Failed to get IP address:", error);
      commenterIP = 'Unknown'; 
    }
    const newComment = {
        post_slug: currentPageSlug,
        author_name: '访客', // 可替换为登录用户信息
        commenter_ip: commenterIP,
        content: content
    };

    const { data, error } = await supabase
        .from('comments')
        .insert([newComment]);

    if (error) {
        console.error('Error submitting comment:', error);
        alert('提交失败，请重试。');
    } else {
        // 清空表单
        e.target.reset();
        // 重新加载评论列表（或直接在前端添加新评论）
        loadComments();
    }
});

// 页面加载时获取评论
document.addEventListener('DOMContentLoaded', loadComments);
</script>
