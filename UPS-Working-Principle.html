<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS 最终完美版</title>
    <style>
        :root {
            --bg-color: #1e1e24;
            --panel-color: #2b2b35;
            --color-mains: #00ff88;    /* 主路 - 绿 */
            --color-battery: #ffaa00;  /* 电池 - 橙 */
            --color-bypass: #00ccff;   /* 旁路 - 蓝 */
            --color-maint: #e040fb;    /* 维修 - 紫 */
            --color-off: #444;         /* 断路 - 灰 */
            --component-fill: #3a3a45;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: var(--panel-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        /* 按钮组 */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        button {
            padding: 10px 20px;
            border: 1px solid #555;
            background: var(--component-fill);
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }
        
        button:hover { filter: brightness(1.2); transform: translateY(-2px); }
        button.active { border-color: #fff; box-shadow: 0 0 12px rgba(255,255,255,0.15); font-weight: bold;}

        button[data-mode="normal"].active { background: var(--color-mains); color: #000; }
        button[data-mode="battery"].active { background: var(--color-battery); color: #000; }
        button[data-mode="bypass"].active { background: var(--color-bypass); color: #000; }
        button[data-mode="maint"].active { background: var(--color-maint); color: #fff; }
        button[data-mode="off"].active { background: #ff4444; color: #fff; }

        /* 图表区 */
        .diagram {
            position: relative;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            padding-bottom: 50%;
        }

        svg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        /* 文本 */
        .label-text { fill: #ccc; font-size: 12px; font-weight: 600; text-anchor: end;}
        .label-sub { fill: #666; font-size: 10px; text-anchor: end;}

        /* 线条 */
        .wire {
            fill: none;
            stroke: var(--color-off);
            stroke-width: 4;
            stroke-linecap: square; 
            stroke-linejoin: miter;
            transition: stroke 0.3s;
        }

        /* 虚线流动动画 */
        .dashed-flow { stroke-dasharray: 12 12; animation: flow 1s linear infinite; }
        .dashed-flow-reverse { stroke-dasharray: 12 12; animation: flow-rev 1s linear infinite; }
        @keyframes flow { to { stroke-dashoffset: -24; } }
        @keyframes flow-rev { to { stroke-dashoffset: 24; } }

        /* 状态色 */
        .stroke-mains { stroke: var(--color-mains); }
        .stroke-battery { stroke: var(--color-battery); }
        .stroke-bypass { stroke: var(--color-bypass); }
        .stroke-maint { stroke: var(--color-maint); }

        /* 箭头 */
        .static-arrow { fill: var(--color-off); transition: fill 0.3s; }
        .fill-mains { fill: var(--color-mains); }
        .fill-battery { fill: var(--color-battery); }
        .fill-bypass { fill: var(--color-bypass); }
        .fill-maint { fill: var(--color-maint); }
        .arrow-hidden { display: none; }

        /* 组件盒子 */
        .comp-box { fill: var(--component-fill); stroke: #888; stroke-width: 2; }
        .comp-text { fill: #fff; font-size: 14px; font-weight: bold; text-anchor: middle; pointer-events: none; }
        
        /* 描述区 */
        .desc { margin-top: 15px; padding: 15px; border-left: 4px solid #fff; background: rgba(255,255,255,0.05); }

    </style>
</head>
<body>

    <h2>UPS 工作原理演示</h2>

    <div class="container">
        <div class="controls">
            <button data-mode="normal" onclick="setMode('normal')" class="active">市电模式</button>
            <button data-mode="battery" onclick="setMode('battery')">电池模式</button>
            <button data-mode="bypass" onclick="setMode('bypass')">旁路模式</button>
            <button data-mode="maint" onclick="setMode('maint')">维修模式</button>
            <button data-mode="off" onclick="setMode('off')">关机</button>
        </div>

        <div class="diagram">
            <svg viewBox="0 0 900 450">
                
                <!-- === 左侧输入标签 === -->
                <text x="90" y="145" class="label-text">旁路输入</text>
                <text x="90" y="160" class="label-sub">Bypass Input</text>

                <text x="90" y="265" class="label-text">主路输入</text>
                <text x="90" y="280" class="label-sub">Mains Input</text>

                <!-- === 线路层 === -->

                <!-- 1. 旁路输入 (起点 x=100) -->
                <path id="w-bp-src" d="M 100 140 L 160 140" class="wire" />
                <!-- 1a. 维修旁路 (上层) -->
                <path id="w-maint" d="M 160 140 L 160 50 L 820 50 L 820 220" class="wire" />
                <!-- 1b. 静态旁路 (中层) -->
                <path id="w-bp-path" d="M 160 140 L 670 140 L 670 220" class="wire" />

                <!-- 2. 主路输入 -> 整流器 -->
                <path id="w-mains" d="M 100 260 L 220 260" class="wire" />

                <!-- 3. 直流母线 (关键修改：拆分为左右两段) -->
                <!-- DC Left: 整流器(320) 到 电池节点(370) -->
                <path id="w-dc-left" d="M 320 260 L 370 260" class="wire" />
                <!-- DC Right: 电池节点(370) 到 逆变器(420) -->
                <path id="w-dc-right" d="M 370 260 L 420 260" class="wire" />

                <!-- 4. 电池连接 (垂直线) -->
                <path id="w-bat" d="M 370 260 L 370 370" class="wire" />

                <!-- 5. 逆变器 -> STS -->
                <path id="w-inv-out" d="M 520 260 L 620 260" class="wire" />

                <!-- 6. STS -> 负载 -->
                <path id="w-load" d="M 720 260 L 820 260" class="wire" />


                <!-- === 箭头指示 === -->
                
                <!-- 旁路输入 -->
                <polygon id="a-bp-in" points="120,134 130,140 120,146" class="static-arrow arrow-hidden" />
                <!-- 维修旁路 -->
                <polygon id="a-maint" points="480,44 490,50 480,56" class="static-arrow arrow-hidden" />
                <!-- 静态旁路 -->
                <polygon id="a-bp-sts" points="400,134 410,140 400,146" class="static-arrow arrow-hidden" />

                <!-- 主路输入 -->
                <polygon id="a-mains" points="150,254 160,260 150,266" class="static-arrow" />
                
                <!-- 直流母线箭头 (移到右侧段，因为它是公共流向段) -->
                <!-- 位于 390 (电池节点370 和 逆变器420 之间) -->
                <polygon id="a-dc" points="390,254 400,260 390,266" class="static-arrow" />

                <!-- 电池充放电 -->
                <polygon id="a-bat-chg" points="364,310 370,320 376,310" class="static-arrow arrow-hidden" />
                <polygon id="a-bat-dis" points="364,300 370,290 376,300" class="static-arrow arrow-hidden" />

                <!-- 逆变输出 -->
                <polygon id="a-inv" points="560,254 570,260 560,266" class="static-arrow" />
                <!-- 负载输入 -->
                <polygon id="a-load" points="760,254 770,260 760,266" class="static-arrow" />


                <!-- === 组件模块 (统一大小 100x80) === -->
                
                <!-- 维修开关 Q3 -->
                <g transform="translate(450, 50)">
                    <text x="0" y="-15" fill="#aaa" font-size="12" text-anchor="middle">Q3 维修开关</text>
                    <circle cx="-20" cy="0" r="3" fill="#888"/>
                    <circle cx="20" cy="0" r="3" fill="#888"/>
                    <line id="sw-maint" x1="-20" y1="0" x2="15" y2="-15" stroke="#fff" stroke-width="3" />
                </g>

                <!-- 整流器 -->
                <rect x="220" y="220" width="100" height="80" rx="3" class="comp-box"/>
                <text x="270" y="250" class="comp-text">整流器</text>
                <text x="270" y="270" class="comp-text" style="font-size:10px; fill:#aaa">AC/DC</text>

                <!-- 逆变器 -->
                <rect x="420" y="220" width="100" height="80" rx="3" class="comp-box"/>
                <text x="470" y="250" class="comp-text">逆变器</text>
                <text x="470" y="270" class="comp-text" style="font-size:10px; fill:#aaa">DC/AC</text>

                <!-- STS -->
                <rect x="620" y="220" width="100" height="80" rx="3" class="comp-box" style="stroke-dasharray: 4;"/>
                <text x="690" y="235" class="comp-text" style="font-size:10px; fill:#aaa">STS</text>
                <!-- STS 内部 -->
                <circle cx="620" cy="260" r="3" fill="#666"/> 
                <circle cx="670" cy="220" r="3" fill="#666"/> 
                <circle cx="720" cy="260" r="3" fill="#fff"/> 
                <line id="sw-sts" x1="720" y1="260" x2="620" y2="260" stroke="#fff" stroke-width="3" />

                <!-- 负载 -->
                <rect x="820" y="220" width="80" height="80" rx="3" class="comp-box" style="fill:#222"/>
                <text x="860" y="260" class="comp-text">负载</text>

                <!-- 电池 -->
                <rect x="320" y="370" width="100" height="50" rx="3" class="comp-box"/>
                <text x="370" y="400" class="comp-text">电池组</text>

            </svg>
        </div>

        <div class="desc" id="desc-box">
            <h3 id="desc-title" style="margin:0 0 10px 0;"></h3>
            <p id="desc-text" style="margin:0; color:#ccc;"></p>
        </div>
    </div>

    <script>
        // 元素映射
        const ui = {
            wires: {
                bpSrc: document.getElementById('w-bp-src'),
                maint: document.getElementById('w-maint'),
                bpPath: document.getElementById('w-bp-path'),
                mains: document.getElementById('w-mains'),
                dcLeft: document.getElementById('w-dc-left'),  // 左半段
                dcRight: document.getElementById('w-dc-right'), // 右半段
                bat: document.getElementById('w-bat'),
                invOut: document.getElementById('w-inv-out'),
                load: document.getElementById('w-load')
            },
            arrows: {
                bpIn: document.getElementById('a-bp-in'),
                maint: document.getElementById('a-maint'),
                bpSts: document.getElementById('a-bp-sts'),
                mains: document.getElementById('a-mains'),
                dc: document.getElementById('a-dc'),
                batChg: document.getElementById('a-bat-chg'),
                batDis: document.getElementById('a-bat-dis'),
                inv: document.getElementById('a-inv'),
                load: document.getElementById('a-load')
            },
            swMaint: document.getElementById('sw-maint'),
            swSts: document.getElementById('sw-sts'),
            descTitle: document.getElementById('desc-title'),
            descText: document.getElementById('desc-text'),
            descBox: document.getElementById('desc-box')
        };

        function reset() {
            for(let k in ui.wires) ui.wires[k].setAttribute('class', 'wire');
            for(let k in ui.arrows) {
                ui.arrows[k].classList.add('arrow-hidden');
                ui.arrows[k].classList.remove('fill-mains','fill-battery','fill-bypass','fill-maint');
            }
        }

        function flow(wire, arrow, type, reverse=false) {
            if(ui.wires[wire]) {
                let cls = `wire stroke-${type}`;
                cls += reverse ? ' dashed-flow-reverse' : ' dashed-flow';
                ui.wires[wire].setAttribute('class', cls);
            }
            if(arrow && ui.arrows[arrow]) {
                ui.arrows[arrow].classList.remove('arrow-hidden');
                ui.arrows[arrow].classList.add(`fill-${type}`);
            }
        }

        function toggleMaint(closed) {
            if(closed) {
                ui.swMaint.setAttribute('x2', '20'); ui.swMaint.setAttribute('y2', '0');
            } else {
                ui.swMaint.setAttribute('x2', '15'); ui.swMaint.setAttribute('y2', '-15');
            }
        }

        function toggleSts(pos) {
            if(pos === 'inv') {
                ui.swSts.setAttribute('x2', '620'); ui.swSts.setAttribute('y2', '260');
            } else if (pos === 'bypass') {
                ui.swSts.setAttribute('x2', '670'); ui.swSts.setAttribute('y2', '220');
            } else {
                ui.swSts.setAttribute('x2', '680'); ui.swSts.setAttribute('y2', '240');
            }
        }

        function setMode(mode) {
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[data-mode="${mode}"]`).classList.add('active');
            
            reset();

            if(mode === 'normal') {
                ui.descTitle.innerText = "市电模式 (Normal)";
                ui.descTitle.style.color = "#00ff88";
                ui.descBox.style.borderLeftColor = "#00ff88";
                ui.descText.innerHTML = "<b>主路输入</b>供电。整流器工作，同时点亮 DC 母线的左右两段：左段连接整流器，右段连接逆变器。电池处于充电状态。";

                flow('mains', 'mains', 'mains');
                flow('dcLeft', null, 'mains');  // 左半段亮
                flow('dcRight', 'dc', 'mains'); // 右半段亮 + 箭头
                flow('bat', 'batChg', 'mains');
                flow('invOut', 'inv', 'mains');
                flow('load', 'load', 'mains');
                
                toggleSts('inv');
                toggleMaint(false);

            } else if (mode === 'battery') {
                ui.descTitle.innerText = "电池模式 (Battery)";
                ui.descTitle.style.color = "#ffaa00";
                ui.descBox.style.borderLeftColor = "#ffaa00";
                ui.descText.innerHTML = "主路断电，整流器停止。<b>DC母线左半段无电流</b>（灰色）。电池放电，电流经右半段进入逆变器。";

                flow('bat', 'batDis', 'battery', true);
                
                // 关键变化：左半段不亮，只有右半段亮
                // flow('dcLeft', ...) -> 不调用
                flow('dcRight', 'dc', 'battery'); 

                flow('invOut', 'inv', 'battery');
                flow('load', 'load', 'battery');

                toggleSts('inv');
                toggleMaint(false);

            } else if (mode === 'bypass') {
                ui.descTitle.innerText = "旁路模式 (Static Bypass)";
                ui.descTitle.style.color = "#00ccff";
                ui.descBox.style.borderLeftColor = "#00ccff";
                ui.descText.innerHTML = "负载由旁路输入供电。主路及直流部分完全停止工作。";

                flow('bpSrc', 'bpIn', 'bypass');
                flow('bpPath', 'bpSts', 'bypass');
                flow('load', 'load', 'bypass');

                toggleSts('bypass');
                toggleMaint(false);

            } else if (mode === 'maint') {
                ui.descTitle.innerText = "维修模式 (Maintenance)";
                ui.descTitle.style.color = "#e040fb";
                ui.descBox.style.borderLeftColor = "#e040fb";
                ui.descText.innerHTML = "维修开关闭合。电流走最上层紫色线路。内部模块全部隔离。";

                flow('bpSrc', 'bpIn', 'maint');
                flow('maint', 'maint', 'maint');

                toggleSts('off');
                toggleMaint(true);
            } else {
                ui.descTitle.innerText = "关机";
                ui.descTitle.style.color = "#aaa";
                ui.descBox.style.borderLeftColor = "#aaa";
                ui.descText.innerText = "无输出。";
                toggleSts('off');
                toggleMaint(false);
            }
        }

        setMode('normal');

    </script>
</body>
</html>