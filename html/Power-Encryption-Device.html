<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µåŠ›çºµå‘åŠ å¯†è£…ç½®å·¥ç¨‹éƒ¨ç½²ä¸åŸç†æ¼”ç¤º</title>
    <style>
        :root {
            --zone-secure: #e6f7ff;
            --zone-public: #fff7e6;
            --border-color: #91d5ff;
            --dev-bg: #fff;
            --line-color: #8c8c8c;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        h1 { text-align: center; font-size: 24px; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }

        /* --- æ‹“æ‰‘åŒºåŸŸ --- */
        .topology-map {
            position: relative;
            height: 320px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            background: #fff;
            overflow: hidden;
        }

        /* åŒºåŸŸåˆ’åˆ†èƒŒæ™¯ */
        .zone {
            position: absolute;
            top: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 10px;
            font-size: 12px;
            font-weight: bold;
            color: #999;
            border-right: 1px dashed #ccc;
        }
        .zone-left { left: 0; width: 35%; background: var(--zone-secure); }
        .zone-mid { left: 35%; width: 30%; background: var(--zone-public); }
        .zone-right { left: 65%; width: 35%; background: var(--zone-secure); border-right: none;}

        .zone-label { margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* è®¾å¤‡å›¾æ ‡ */
        .device {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: white;
            border: 2px solid #595959;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 11px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .device i { font-size: 24px; margin-bottom: 4px; font-style: normal; display: block; }
        .device-active { border-color: #1890ff; box-shadow: 0 0 15px #1890ff; }

        /* å…·ä½“ä½ç½®é…ç½® */
        #dev-host { left: 8%; border-color: #595959; }
        #dev-sw1  { left: 20%; border-color: #13c2c2; color: #13c2c2; } /* æ ¸å¿ƒäº¤æ¢æœº */
        #dev-enc1 { left: 32%; background: #333; color: #00e5ff; border-color: #333; height: 80px; width: 50px; border-radius: 4px;} /* åŠ å¯†è£…ç½® */
        #dev-r1   { left: 42%; border-radius: 50%; width: 60px; height: 60px; border-color: #722ed1; color: #722ed1;} /* æ¥å…¥è·¯ç”±å™¨ */
        
        #dev-cloud{ left: 50%; width: 80px; height: 50px; border: 2px dashed #ccc; background: transparent; box-shadow: none; z-index: 5;}
        
        #dev-r2   { left: 58%; border-radius: 50%; width: 60px; height: 60px; border-color: #722ed1; color: #722ed1;}
        #dev-enc2 { left: 68%; background: #333; color: #00e5ff; border-color: #333; height: 80px; width: 50px; border-radius: 4px;}
        #dev-sw2  { left: 80%; border-color: #13c2c2; color: #13c2c2; }
        #dev-rtu  { left: 92%; border-color: #595959; }

        /* è¿çº¿ */
        .link-line {
            position: absolute;
            top: 50%;
            height: 3px;
            background: #d9d9d9;
            z-index: 1;
            transform: translateY(-50%);
        }

        /* çŠ¶æ€æŒ‡ç¤ºç¯ */
        .led {
            width: 8px; height: 8px; border-radius: 50%; background: #555;
            margin-top: 5px; box-shadow: 0 0 2px #000;
        }
        .led.on { background: #52c41a; box-shadow: 0 0 5px #52c41a; }
        .led.negotiating { background: #faad14; animation: blink 0.5s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* æ•°æ®åŒ… */
        .packet {
            position: absolute;
            top: 50%;
            left: 8%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            z-index: 20;
            display: none; /* åˆå§‹éšè— */
            transition: left 0.5s linear;
        }
        
        /* æŠ¥æ–‡å½¢çŠ¶ */
        .pkt-plain { background: #f5222d; border-radius: 50%; border: 2px solid #fff; }
        .pkt-enc   { background: #1890ff; width: 30px; height: 16px; border-radius: 4px; border: 1px solid #0050b3; } /* é•¿æ–¹å½¢ä»£è¡¨å°è£… */

        /* --- åº•éƒ¨æ§åˆ¶å° --- */
        .console-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .monitor-panel {
            background: #262626;
            color: #00ff00;
            padding: 15px;
            font-family: 'Consolas', monospace;
            border-radius: 5px;
            height: 180px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 3px solid #555;
        }

        .packet-viewer {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #444;
            margin-bottom: 10px;
        }

        .packet-block {
            padding: 5px 8px;
            border: 1px solid #fff;
            margin: 0 2px;
            font-size: 12px;
            background: #333;
            color: #fff;
        }
        .blk-tunnel { background: #0050b3; border-color: #1890ff; color: #fff; }
        .blk-esp    { background: #0050b3; border-color: #1890ff; font-weight: bold; }
        .blk-data   { background: #f5222d; color: white; }
        .blk-enc-data { background: #434343; color: #00e5ff; letter-spacing: 2px; }

        .log-area {
            height: 60px;
            font-size: 11px;
            color: #aaa;
            overflow-y: auto;
            line-height: 1.4;
        }
        .log-entry { margin-bottom: 2px; }
        .log-time { color: #1890ff; margin-right: 5px; }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
        }
        
        button {
            padding: 12px;
            font-size: 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #1890ff;
            color: white;
            font-weight: bold;
            transition: 0.2s;
        }
        button:hover { background: #40a9ff; }
        button:disabled { background: #d9d9d9; color: #999; cursor: not-allowed; }
        
        .btn-reset { background: white; border: 1px solid #d9d9d9; color: #666; }

    </style>
</head>
<body>

<div class="container">
    <h1>çºµå‘åŠ å¯†è£…ç½®ï¼šéš§é“æ¨¡å¼å°è£…åŸç†æ¼”ç¤º</h1>
    <p class="subtitle">åœºæ™¯ï¼šè°ƒåº¦ä¸­å¿ƒï¼ˆå®‰å…¨IåŒºï¼‰å‘å˜ç”µç«™ï¼ˆå®‰å…¨IåŒºï¼‰å‘é€é¥æ§æŒ‡ä»¤</p>

    <!-- ç‰©ç†æ‹“æ‰‘å±‚ -->
    <div class="topology-map">
        <!-- åŒºåŸŸèƒŒæ™¯ -->
        <div class="zone zone-left">
            <span class="zone-label">ä¸»ç«™ä¾§ Â· å®‰å…¨IåŒº (å†…ç½‘)</span>
        </div>
        <div class="zone zone-mid">
            <span class="zone-label">è°ƒåº¦æ•°æ®ç½‘ (SPDnet)</span>
        </div>
        <div class="zone zone-right">
            <span class="zone-label">å˜ç”µç«™ä¾§ Â· å®‰å…¨IåŒº (å†…ç½‘)</span>
        </div>

        <!-- è¿çº¿ -->
        <div class="link-line" style="left:8%; width:84%;"></div>

        <!-- è®¾å¤‡èŠ‚ç‚¹ -->
        <div class="device" id="dev-host">
            <i>ğŸ–¥ï¸</i>SCADA<br>10.1.1.5
        </div>
        <div class="device" id="dev-sw1">
            <i>â‡†</i>æ ¸å¿ƒäº¤æ¢<br>Layer 3
        </div>
        <div class="device" id="dev-enc1">
            <div style="font-size:16px;">ğŸ›¡ï¸</div>
            çºµå‘åŠ å¯†<br>
            <div class="led" id="led-enc1"></div>
        </div>
        <div class="device" id="dev-r1">
            <i>ğŸ•¸ï¸</i>æ¥å…¥è·¯ç”±
        </div>
        
        <div class="device" id="dev-cloud" style="color:#aaa;">SPDnet<br>WAN</div>

        <div class="device" id="dev-r2">
            <i>ğŸ•¸ï¸</i>æ¥å…¥è·¯ç”±
        </div>
        <div class="device" id="dev-enc2">
            <div style="font-size:16px;">ğŸ›¡ï¸</div>
            çºµå‘åŠ å¯†<br>
            <div class="led" id="led-enc2"></div>
        </div>
        <div class="device" id="dev-sw2">
            <i>â‡†</i>ç«™å†…äº¤æ¢
        </div>
        <div class="device" id="dev-rtu">
            <i>âš¡</i>æµ‹æ§è£…ç½®<br>10.2.2.8
        </div>

        <!-- ç§»åŠ¨çš„æ•°æ®åŒ… -->
        <div class="packet pkt-plain" id="packet"></div>
    </div>

    <!-- åº•éƒ¨ç›‘æ§ä¸æ§åˆ¶ -->
    <div class="console-grid">
        <div class="monitor-panel">
            <!-- æŠ¥æ–‡è§£å‰–å™¨ -->
            <div class="packet-viewer" id="packetView">
                <span style="color:#666; font-size:12px;">[ç­‰å¾…æ•°æ®ç”Ÿæˆ...]</span>
            </div>
            <!-- ç³»ç»Ÿæ—¥å¿—æ¨¡æ‹Ÿ -->
            <div class="log-area" id="sysLog">
                <div class="log-entry">> ç³»ç»Ÿå°±ç»ªã€‚ç­‰å¾…æ“ä½œæŒ‡ä»¤ã€‚</div>
            </div>
        </div>

        <div class="controls">
            <button id="btn-negotiate" onclick="startNegotiation()">1. å»ºç«‹åŠ å¯†éš§é“ (IKEåå•†)</button>
            <button id="btn-send" onclick="startTransmission()" disabled>2. å‘é€æ§åˆ¶æŒ‡ä»¤</button>
            <button class="btn-reset" onclick="resetAll()">é‡ç½®ç³»ç»Ÿ</button>
        </div>
    </div>
</div>

<script>
    // çŠ¶æ€ä¸é…ç½®
    const devEnc1Led = document.getElementById('led-enc1');
    const devEnc2Led = document.getElementById('led-enc2');
    const packet = document.getElementById('packet');
    const packetView = document.getElementById('packetView');
    const sysLog = document.getElementById('sysLog');
    
    // è®¾å¤‡ä½ç½® (ç™¾åˆ†æ¯”)
    const pos = {
        host: 8,
        sw1: 20,
        enc1: 32,
        r1: 42,
        cloud: 50,
        r2: 58,
        enc2: 68,
        sw2: 80,
        rtu: 92
    };

    let isTunnelReady = false;

    // å·¥å…·å‡½æ•°ï¼šå†™æ—¥å¿—
    function log(msg) {
        const time = new Date().toLocaleTimeString('zh-CN', {hour12: false});
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
        sysLog.insertBefore(entry, sysLog.firstChild);
    }

    // å·¥å…·å‡½æ•°ï¼šç§»åŠ¨ç‰©ä½“
    function move(element, targetPct, duration = 1000) {
        return new Promise(resolve => {
            element.style.display = 'block';
            element.style.transition = `left ${duration}ms linear`;
            
            // å¼ºåˆ¶é‡ç»˜
            void element.offsetWidth; 
            
            element.style.left = targetPct + '%';
            setTimeout(resolve, duration);
        });
    }

    // å·¥å…·å‡½æ•°ï¼šé«˜äº®è®¾å¤‡
    function highlight(devId, active) {
        const dev = document.getElementById(devId);
        if (active) dev.classList.add('device-active');
        else dev.classList.remove('device-active');
    }

    // --- æ­¥éª¤1ï¼šåå•†è¿‡ç¨‹ ---
    async function startNegotiation() {
        document.getElementById('btn-negotiate').disabled = true;
        log("å¼€å§‹ IKE åå•†... æ­£åœ¨æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§");
        
        devEnc1Led.className = 'led negotiating';
        devEnc2Led.className = 'led negotiating';
        
        await new Promise(r => setTimeout(r, 1500));
        log("ä¸»ç«™ä¾§åŠ å¯†è£…ç½®ï¼šè¯ä¹¦éªŒè¯é€šè¿‡ï¼Œç”³è¯·å»ºç«‹SA (Security Association)");
        
        await new Promise(r => setTimeout(r, 1500));
        log("å˜ç”µç«™ä¾§åŠ å¯†è£…ç½®ï¼šåŒæ„SAè¯·æ±‚ã€‚å¯†é’¥äº¤æ¢å®Œæˆã€‚");
        
        devEnc1Led.className = 'led on';
        devEnc2Led.className = 'led on';
        isTunnelReady = true;
        document.getElementById('btn-send').disabled = false;
        log("éš§é“å»ºç«‹æˆåŠŸï¼ç­–ç•¥ï¼šå…è®¸ 10.1.1.5 -> 10.2.2.8 (TCP 2404)");
    }

    // --- æ­¥éª¤2ï¼šä¼ è¾“è¿‡ç¨‹ ---
    async function startTransmission() {
        if (!isTunnelReady) return;
        document.getElementById('btn-send').disabled = true;
        
        // é‡ç½®åŒ…ä½ç½®
        packet.className = 'packet pkt-plain';
        packet.style.transition = 'none';
        packet.style.left = pos.host + '%';
        
        // 1. Host -> SW1
        log("ä¸»æœºç”Ÿæˆ104è§„çº¦æŠ¥æ–‡ï¼Œä¸‹ä¸€è·³æŒ‡å‘æ ¸å¿ƒäº¤æ¢æœºç½‘å…³ã€‚");
        updatePacketUI('plain');
        highlight('dev-host', true);
        await move(packet, pos.sw1, 1000);
        highlight('dev-host', false);

        // 2. SW1 -> Enc1
        log("æ ¸å¿ƒäº¤æ¢æœºè·¯ç”±æŸ¥æ‰¾ï¼šç›®æ ‡ç½‘æ®µéœ€èµ°çºµå‘åŠ å¯†è£…ç½®ã€‚è½¬å‘ä¸­...");
        highlight('dev-sw1', true);
        await move(packet, pos.enc1, 800);
        highlight('dev-sw1', false);

        // 3. Enc1 å¤„ç† (å…³é”®)
        log(">> åˆ°è¾¾ä¸»ç«™åŠ å¯†è£…ç½®ã€‚åŒ¹é…ç­–ç•¥ï¼Œæ‰§è¡Œ ESP éš§é“å°è£…ä¸åŠ å¯†ã€‚");
        highlight('dev-enc1', true);
        await new Promise(r => setTimeout(r, 800)); // å¤„ç†å»¶æ—¶
        
        // å˜èº«ï¼šå°è£…
        packet.className = 'packet pkt-enc'; // å˜è“ï¼Œå˜æ–¹
        updatePacketUI('encrypted');
        log("æŠ¥æ–‡å·²å°è£…ï¼šå¤–å±‚IPæ”¹ä¸ºåŠ å¯†è£…ç½®äº’è”åœ°å€ã€‚å†…å±‚IPåŠè½½è·å·²åŠ å¯†ã€‚");
        
        // 4. Enc1 -> R1 -> Cloud -> R2 -> Enc2
        log("å‘é€è‡³æ¥å…¥è·¯ç”±å™¨ï¼Œè¿›å…¥è°ƒåº¦æ•°æ®ç½‘ã€‚");
        highlight('dev-enc1', false);
        highlight('dev-r1', true); // è·¯ç”±å™¨åªåšè½¬å‘ï¼Œä¸çœ‹å†…å®¹
        
        // ä¸€æ°”å‘µæˆç©¿è¿‡å…¬ç½‘ï¼Œä½“ç°éš§é“æ„Ÿ
        await move(packet, pos.enc2, 2500); 
        highlight('dev-r1', false);
        
        // 5. Enc2 å¤„ç†
        log(">> åˆ°è¾¾å˜ç”µç«™åŠ å¯†è£…ç½®ã€‚éªŒè¯ESPå®Œæ•´æ€§æ ¡éªŒå€¼(ICV)...é€šè¿‡ã€‚");
        highlight('dev-enc2', true);
        await new Promise(r => setTimeout(r, 800));
        
        // å˜èº«ï¼šè§£å°è£…
        packet.className = 'packet pkt-plain'; // å˜å›çº¢çƒ
        updatePacketUI('plain');
        log("è§£å¯†æˆåŠŸã€‚å‰¥ç¦»éš§é“å¤´ï¼Œè¿˜åŸåŸå§‹æŠ¥æ–‡ã€‚");
        
        // 6. Enc2 -> SW2 -> RTU
        highlight('dev-enc2', false);
        highlight('dev-sw2', true);
        log("è½¬å‘è‡³ç«™å†…äº¤æ¢æœº...");
        await move(packet, pos.sw2, 800);
        
        highlight('dev-sw2', false);
        highlight('dev-rtu', true);
        log("æµ‹æ§è£…ç½®æ¥æ”¶æŒ‡ä»¤ï¼šæ‰§è¡Œåˆé—¸ï¼");
        await move(packet, pos.rtu, 800);

        log("æ¼”ç¤ºç»“æŸã€‚ä¸šåŠ¡æµç¨‹é—­ç¯ã€‚");
        document.getElementById('btn-send').innerText = "ä¼ è¾“å®Œæˆ";
    }

    function updatePacketUI(type) {
        if (type === 'plain') {
            packetView.innerHTML = `
                <div class="packet-block blk-data">IPå¤´: 10.1.x.x</div>
                <div class="packet-block blk-data">TCP</div>
                <div class="packet-block blk-data">104è½½è·</div>
            `;
        } else {
            packetView.innerHTML = `
                <div class="packet-block blk-tunnel">å¤–å±‚IP: å…¬ç½‘äº’è”</div>
                <div class="packet-block blk-esp">ESPå¤´</div>
                <div class="packet-block blk-enc-data">$$å¯†æ–‡$$</div>
                <div class="packet-block blk-esp">ESPå°¾+Auth</div>
            `;
        }
    }

    function resetAll() {
        location.reload();
    }

</script>

</body>
</html>