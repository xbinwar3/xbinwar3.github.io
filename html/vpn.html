<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN åŸç†ï¼šåŠ è§£å¯†ä¸å†…å®¹ä¼ è¾“</title>
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --border: #333;
            --accent: #00bcd4;
            --text-main: #e0e0e0;
            --text-dim: #757575;
            --enc-color: #ff5252;
            --clr-color: #69f0ae;
            --font-mono: 'Consolas', 'Monaco', monospace;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
            margin: 0 auto; /* å±…ä¸­ */
            max-width: 740px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* --- é¡¶éƒ¨æ§åˆ¶æ  --- */
        .header {
            padding: 10px 15px;
            background: #252526;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 16px; flex: 1; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .controls button {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 6px 12px; cursor: pointer; border-radius: 4px;
            transition: 0.2s; font-weight: bold; font-size: 12px;
        }
        .controls button.primary { background: var(--accent); color: #000; border-color: var(--accent); }
        .controls button:hover { brightness: 1.1; transform: translateY(-1px); }
        .controls button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- ä¸»èˆå° --- */
        .stage {
            flex: 1;
            position: relative;
            padding: 20px 10px; /* å‡å°å†…è¾¹è· */
            display: flex;
            justify-content: space-between; /* å‡åŒ€åˆ†å¸ƒ */
            align-items: center;
            background-image: linear-gradient(#222 1px, transparent 1px), linear-gradient(90deg, #222 1px, transparent 1px);
            background-size: 40px 40px;
            overflow: hidden;
        }

        /* ç‰©ç†è¿æ¥çº¿ */
        .cable {
            position: absolute;
            top: 50%; left: 40px; right: 40px;
            height: 4px; background: #333; z-index: 0;
            border-radius: 4px;
        }

        /* èŠ‚ç‚¹æ¡† (é€‚é… 740pxï¼Œå®½åº¦è°ƒå°) */
        .node {
            width: 180px; /* ä»240pxç¼©å°åˆ°180px */
            height: 360px;
            background: var(--panel);
            border: 2px solid #444;
            border-radius: 6px;
            z-index: 2;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            position: relative;
        }
        .node-title {
            background: #333; padding: 8px; text-align: center;
            font-weight: bold; border-bottom: 1px solid #444; font-size: 13px;
        }
        
        /* å†…éƒ¨å±‚çº§ */
        .space {
            flex: 1; margin: 6px; border: 1px dashed #555;
            border-radius: 4px; padding: 4px; position: relative;
        }
        .space-label {
            position: absolute; top: -8px; left: 6px;
            background: var(--panel); font-size: 9px; color: #888; padding: 0 4px;
        }
        
        /* ç»„ä»¶æ¨¡å— */
        .module {
            background: #444; margin: 4px 0; padding: 8px 4px;
            text-align: center; font-size: 11px; border-radius: 3px;
            border: 1px solid #555; transition: 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .module.crypto { background: #e65100; color: white; border-color: #ff9800; }
        .module.active { box-shadow: 0 0 15px var(--accent); border-color: var(--accent); transform: scale(1.02); }
        .module.processing { animation: pulse 0.5s infinite alternate; }

        @keyframes pulse { from { opacity: 0.7; } to { opacity: 1; } }

        /* é”å›¾æ ‡åŠ¨ç”» */
        .lock-icon {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 32px; color: gold; z-index: 20;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 10px black;
        }

        /* æ•°æ®åŒ… */
        .packet {
            position: absolute; top: 50%; left: 100px; /* åˆå§‹ä½ç½® */
            transform: translate(-50%, -50%);
            width: 50px; height: 34px;
            background: white; border-radius: 4px;
            z-index: 10;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            box-shadow: 0 0 10px white;
            transition: left 1s ease-in-out, background 0.5s;
        }
        .packet.encrypted { background: var(--enc-color); box-shadow: 0 0 10px var(--enc-color); color: #fff; }
        .packet.clear { background: var(--clr-color); box-shadow: 0 0 10px var(--clr-color); color: #000; }

        /* --- åº•éƒ¨è¯¦æƒ…é¢æ¿ --- */
        .dashboard {
            height: 180px; background: #181818;
            border-top: 1px solid var(--border);
            display: grid; grid-template-columns: 1.2fr 1fr; /* å·¦è¾¹ç¨å¾®å®½ä¸€ç‚¹ */
            flex-shrink: 0;
        }
        
        /* å·¦ä¾§æ—¥å¿— */
        .logs { padding: 10px; overflow-y: auto; font-family: var(--font-mono); font-size: 11px; border-right: 1px solid var(--border); }
        .log-entry { margin-bottom: 5px; opacity: 0.8; }
        .log-entry.highlight { color: var(--accent); opacity: 1; font-weight: bold; border-left: 2px solid var(--accent); padding-left: 6px; }

        /* å³ä¾§è½½è·ç›‘è§†å™¨ */
        .inspector { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .insp-row { display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .insp-label { color: var(--text-dim); }
        .insp-val { font-family: var(--font-mono); }
        
        .payload-box {
            background: black; border: 1px solid #333; padding: 8px;
            font-family: var(--font-mono); font-size: 10px;
            height: 50px; overflow: hidden; color: var(--clr-color);
            transition: color 0.3s; word-break: break-all;
        }
        .payload-box.locked { color: var(--enc-color); }
        
        /* ç‰¹æ®Šè°ƒæ•´ï¼šä¸­é—´çš„ Internet äº‘æœµ */
        .cloud-node {
             z-index:1; border-radius:50%; width:80px; height:50px; 
             display:flex; align-items:center; justify-content:center; 
             background:#222; border:2px dashed #666; font-size: 10px;
        }
        
        /* ç‰¹æ®Šè°ƒæ•´ï¼šç›®æ ‡èŠ‚ç‚¹å®½åº¦ */
        .target-node {
            width: 120px; /* è¿›ä¸€æ­¥ç¼©å°ç›®æ ‡èŠ‚ç‚¹ä»¥è…¾å‡ºç©ºé—´ */
        }
        
    </style>
</head>
<body>

<div class="header">
    <h1>VPN åŸç†æ¼”ç¤º</h1>
    <div class="controls">
        <button onclick="reset()">â†º é‡ç½®</button>
        <button onclick="step()" id="btnStep" class="primary">â–¶ ä¸‹ä¸€æ­¥</button>
        <button onclick="toggleAuto()" id="btnAuto">è‡ªåŠ¨</button>
    </div>
</div>

<div class="stage">
    <div class="cable"></div>

    <!-- ç”¨æˆ· -->
    <div class="node" id="node-user">
        <div class="node-title">Client</div>
        <div class="lock-icon" id="lock-user">ğŸ”’</div>
        
        <div class="space">
            <div class="space-label">User Space</div>
            <div class="module" id="mod-browser">ğŸŒ æµè§ˆå™¨</div>
            <div class="module crypto" id="mod-vpn-client">ğŸ”‘ VPN Client</div>
        </div>
        <div class="space">
            <div class="space-label">Kernel</div>
            <div class="module" id="mod-u-tun" style="border-style:dashed">ğŸ“„ tun0: 10.8.0.5</div>
            <div class="module" id="mod-u-eth">ğŸ”Œ eth0: 203.0.113.12</div>
        </div>
    </div>

    <!-- äº’è”ç½‘ -->
    <div class="cloud-node">Internet</div>

    <!-- VPNæœåŠ¡å™¨ -->
    <div class="node" id="node-vpn">
        <div class="node-title">VPN Server</div>
        <div class="lock-icon" id="lock-vpn">ğŸ”“</div>

        <div class="space">
            <div class="space-label">User Space</div>
            <div class="module crypto" id="mod-vpn-server">ğŸ”‘ VPN Server</div>
        </div>
        <div class="space">
            <div class="space-label">Kernel</div>
            <div class="module" id="mod-v-eth">ğŸ”Œ eth0: 198.51.100.22</div>
            <div class="module" id="mod-v-tun" style="border-style:dashed">ğŸ“„ tun0: 10.8.0.1</div>
            <div class="module" id="mod-nat" style="background:#333; color:yellow;">ğŸ”€ NAT</div>
        </div>
    </div>

    <!-- ç›®æ ‡ -->
    <div class="node target-node" style="height: 200px; justify-content:center; align-items:center;">
        <div class="node-title" style="width:100%">Target</div>
        <div style="font-size:40px;">ğŸ¦</div>
        <div style="font-family:monospace; font-size:10px; text-align:center;">bank.com<br>93.184.xx.xx</div>
    </div>

    <!-- æ•°æ®åŒ…å®ä½“ -->
    <div class="packet clear" id="packet">ğŸ“„</div>
</div>

<div class="dashboard">
    <div class="logs" id="logBox">
        <div class="log-entry">> ç³»ç»Ÿå°±ç»ªã€‚ç­‰å¾…å‘èµ·è¯·æ±‚...</div>
    </div>
    <div class="inspector">
        <div class="insp-row">
            <span>çŠ¶æ€: <b id="status-txt">ç­‰å¾…ä¸­</b></span>
            <span>åè®®: <b id="proto-txt">--</b></span>
        </div>
        <div class="insp-row">
            <span>Src: <b id="src-ip" style="color:var(--clr-color)">--</b></span>
            <span>Dst: <b id="dst-ip" style="color:var(--clr-color)">--</b></span>
        </div>
        <div style="font-size:10px; color:#888; margin-top:2px;">Payload:</div>
        <div class="payload-box" id="payload-display">
            [ç©º]
        </div>
    </div>
</div>

<script>
    // --- é…ç½®ä¸æ•°æ® ---
    const IPs = {
        userReal: '203.0.113.12',
        userTun:  '10.8.0.5',
        vpnReal:  '198.51.100.22',
        vpnTun:   '10.8.0.1',
        target:   '93.184.216.34'
    };

    const RealContent = {
        req: "GET /balance HTTP/1.1\nCookie: sess=xyz\nUA: Chrome",
        res: "HTTP/1.1 200 OK\n<h1>$$$</h1>"
    };

    const EncryptedContent = {
        req: "7f 4a b2 91 c0 ... [AES] ... 99 a1",
        res: "e1 00 2f 4a b2 ... [AES] ... 11 4f"
    };

    // é’ˆå¯¹ 740px é‡æ–°è®¡ç®—çš„åæ ‡ (Visual positions)
    // èˆå° padding 10px. 
    // User Node (180px) -> Center = 10 + 90 = 100px
    // Internet (Center) -> 50%
    // VPN Node (180px) -> å³ä¾§å€’æ•°ç¬¬äºŒä¸ª. 
    // Target (120px) -> Right side.
    
    // æˆ‘ä»¬ä½¿ç”¨ calc æ¥é€‚åº”
    const POS = {
        start: '100px', // User center
        isp: '50%',
        vpn: 'calc(100% - 170px)', // å¤§è‡´å¯¹é½ VPN Server ä¸­å¿ƒ
        target: 'calc(100% - 70px)' // Target center
    };

    let stepIndex = 0;
    let autoTimer = null;

    // --- æ­¥éª¤å®šä¹‰ ---
    const steps = [
        // 1. ç”Ÿæˆè¯·æ±‚
        {
            desc: "æµè§ˆå™¨å‘èµ·æ•æ„Ÿè¯·æ±‚",
            action: () => {
                movePacket(POS.start);
                setPacketStyle('clear');
                highlight('mod-browser');
                updateInfo(IPs.userTun, IPs.target, RealContent.req, 'HTTP (æ˜æ–‡)');
                log("1. æµè§ˆå™¨è®¿é—®é“¶è¡Œã€‚è·¯ç”±è¡¨æŒ‡å‘ tun0ã€‚");
            }
        },
        // 2. è¿›å…¥å†…æ ¸è™šæ‹Ÿç½‘å¡
        {
            desc: "å†…æ ¸å°†åŒ…æ¨å…¥ tun0",
            action: () => {
                highlight('mod-u-tun');
                log("2. å†…æ ¸ï¼šæ•°æ®åŒ…è¿›å…¥è™šæ‹Ÿç½‘å¡ tun0ã€‚");
            }
        },
        // 3. VPN å®¢æˆ·ç«¯åŠ å¯† (User Space)
        {
            desc: "VPN å®¢æˆ·ç«¯åŠ å¯†",
            action: () => {
                highlight('mod-vpn-client');
                showLock('lock-user', 'ğŸ”’'); // ä¸Šé”
                setTimeout(() => {
                    setPacketStyle('encrypted'); // å˜çº¢
                    updateInfo(IPs.userReal, IPs.vpnReal, EncryptedContent.req, 'UDP (åŠ å¯†)');
                    document.getElementById('payload-display').classList.add('locked');
                }, 500);
                
                log("3. VPN è½¯ä»¶è¯»å– tun0ï¼ŒåŠ å¯† payloadï¼Œå°è£… UDPã€‚");
            }
        },
        // 4. å‘é€è‡³å…¬ç½‘
        {
            desc: "å…¬ç½‘ä¼ è¾“ (éš§é“)",
            action: () => {
                hideLock('lock-user');
                highlight('mod-u-eth');
                setTimeout(() => { movePacket(POS.isp); highlight(null); }, 300);
                log("4. ç‰©ç†ç½‘å¡å‘é€ã€‚ISP åªèƒ½çœ‹åˆ°ä¹±ç  UDP åŒ…ã€‚");
            }
        },
        // 5. VPN æœåŠ¡ç«¯æ¥æ”¶
        {
            desc: "VPN æœåŠ¡ç«¯è§£å¯†",
            action: () => {
                movePacket(POS.vpn);
                setTimeout(() => {
                    highlight('mod-v-eth');
                    setTimeout(() => highlight('mod-vpn-server'), 500);
                }, 1000);
            }
        },
        // 6. è§£å¯†åŠ¨ä½œ
        {
            desc: "è¿˜åŸæ˜æ–‡",
            action: () => {
                showLock('lock-vpn', 'ğŸ”“'); // å¼€é”
                setTimeout(() => {
                    setPacketStyle('clear'); // å˜ç»¿
                    updateInfo(IPs.userTun, IPs.target, RealContent.req, 'HTTP (è¿˜åŸ)');
                    document.getElementById('payload-display').classList.remove('locked');
                }, 500);
                log("5. VPN æœåŠ¡ç«¯è§£å¯†ï¼Œè¿˜åŸåŸå§‹ HTTP è¯·æ±‚ã€‚");
            }
        },
        // 7. NAT è½¬å‘
        {
            desc: "NAT æºåœ°å€ä¼ªè£…",
            action: () => {
                hideLock('lock-vpn');
                highlight('mod-nat');
                setTimeout(() => {
                    updateInfo(IPs.vpnReal, IPs.target, RealContent.req, 'HTTP (NATå)');
                    document.getElementById('src-ip').style.color = 'yellow'; // æç¤ºå˜åŒ–
                }, 500);
                log("6. SNAT: æº IP å˜ä¸ºæœåŠ¡å™¨å…¬ç½‘ IPï¼Œä»¥ä¾¿å›ä¿¡ã€‚");
            }
        },
        // 8. åˆ°è¾¾ç›®æ ‡
        {
            desc: "åˆ°è¾¾é“¶è¡ŒæœåŠ¡å™¨",
            action: () => {
                movePacket(POS.target);
                highlight(null);
                log("7. é“¶è¡Œæ”¶åˆ°è¯·æ±‚ï¼Œå¤„ç†ä¸šåŠ¡...");
            }
        },
        // --- å›ç¨‹ ---
        {
            desc: "é“¶è¡Œå›ä¼ æ•°æ®",
            action: () => {
                updateInfo(IPs.target, IPs.vpnReal, RealContent.res, 'HTTP (å“åº”)');
                log("8. é“¶è¡Œå›ä¼ æ•°æ®ç»™ VPN æœåŠ¡å™¨ã€‚");
            }
        },
        // 9. å›åˆ° VPN æœåŠ¡å™¨
        {
            desc: "VPN æ¥æ”¶å›åŒ… & DNAT",
            action: () => {
                movePacket(POS.vpn);
                setTimeout(() => {
                    highlight('mod-nat');
                    updateInfo(IPs.target, IPs.userTun, RealContent.res, 'HTTP (DNAT)');
                    document.getElementById('dst-ip').style.color = 'yellow';
                }, 800);
                log("9. VPN æœåŠ¡å™¨æ”¶åˆ°å›åŒ…ã€‚DNAT è¿˜åŸç›®çš„ IP ä¸ºç”¨æˆ·å†…ç½‘ IPã€‚");
            }
        },
        // 10. åŠ å¯†å›åŒ…
        {
            desc: "VPN åŠ å¯†å›ä¼ ",
            action: () => {
                highlight('mod-vpn-server');
                showLock('lock-vpn', 'ğŸ”’');
                setTimeout(() => {
                    setPacketStyle('encrypted');
                    updateInfo(IPs.vpnReal, IPs.userReal, EncryptedContent.res, 'UDP (åŠ å¯†)');
                    document.getElementById('payload-display').classList.add('locked');
                }, 500);
                log("10. å†æ¬¡åŠ å¯†ï¼Œå°è£… UDP å‘å›ç»™ç”¨æˆ·ã€‚");
            }
        },
        // 11. å…¬ç½‘å›ç¨‹
        {
            desc: "å…¬ç½‘å›ç¨‹",
            action: () => {
                hideLock('lock-vpn');
                movePacket(POS.isp);
                highlight(null);
                log("11. åŠ å¯†æ•°æ®åŒ…ç©¿è¿‡äº’è”ç½‘ã€‚");
            }
        },
        // 12. ç”¨æˆ·è§£å¯†
        {
            desc: "ç”¨æˆ·ç«¯è§£å¯†",
            action: () => {
                movePacket(POS.start);
                setTimeout(() => {
                    highlight('mod-vpn-client');
                    showLock('lock-user', 'ğŸ”“'); // å¼€é”
                }, 800);
                
                setTimeout(() => {
                    setPacketStyle('clear');
                    updateInfo(IPs.target, IPs.userTun, RealContent.res, 'HTTP (å®Œæˆ)');
                    document.getElementById('payload-display').classList.remove('locked');
                    hideLock('lock-user');
                    highlight('mod-browser');
                }, 1500);
                
                log("12. å®¢æˆ·ç«¯è§£å¯†ã€‚æµè§ˆå™¨æ˜¾ç¤ºå†…å®¹ã€‚æµç¨‹ç»“æŸã€‚");
            }
        }
    ];

    // --- è¾…åŠ©å‡½æ•° ---

    function highlight(id) {
        document.querySelectorAll('.module').forEach(el => el.classList.remove('active', 'processing'));
        if(id) {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('active');
                if(id.includes('vpn') || id.includes('nat')) el.classList.add('processing');
            }
        }
    }

    function movePacket(leftVal) {
        const p = document.getElementById('packet');
        p.style.opacity = 1;
        p.style.left = leftVal;
    }

    function setPacketStyle(type) {
        const p = document.getElementById('packet');
        if(type === 'encrypted') {
            p.className = 'packet encrypted';
            p.innerHTML = 'ğŸ”’';
        } else {
            p.className = 'packet clear';
            p.innerHTML = 'ğŸ“„';
        }
    }

    function updateInfo(src, dst, content, proto) {
        document.getElementById('src-ip').innerText = src;
        document.getElementById('src-ip').style.color = ''; // reset
        document.getElementById('dst-ip').innerText = dst;
        document.getElementById('dst-ip').style.color = ''; // reset
        
        const box = document.getElementById('payload-display');
        box.innerText = content;
        
        document.getElementById('proto-txt').innerText = proto;
    }

    function log(msg) {
        const box = document.getElementById('logBox');
        const div = document.createElement('div');
        div.className = 'log-entry highlight';
        div.innerHTML = msg;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function showLock(id, icon) {
        const el = document.getElementById(id);
        el.innerText = icon;
        el.style.transform = 'translate(-50%, -50%) scale(1)';
    }

    function hideLock(id) {
        const el = document.getElementById(id);
        el.style.transform = 'translate(-50%, -50%) scale(0)';
    }

    // --- æ§åˆ¶é€»è¾‘ ---

    function step() {
        if(stepIndex < steps.length) {
            document.getElementById('status-txt').innerText = steps[stepIndex].desc;
            steps[stepIndex].action();
            stepIndex++;
        } else {
            reset();
        }
        
        const btn = document.getElementById('btnStep');
        btn.innerText = (stepIndex >= steps.length) ? "â†º é‡ç½®" : "â–¶ ä¸‹ä¸€æ­¥";
    }

    function reset() {
        stepIndex = 0;
        document.getElementById('logBox').innerHTML = '<div class="log-entry">> ç³»ç»Ÿå·²é‡ç½®ã€‚</div>';
        document.getElementById('packet').style.opacity = 0;
        document.getElementById('packet').style.left = POS.start;
        highlight(null);
        hideLock('lock-user');
        hideLock('lock-vpn');
        document.getElementById('payload-display').innerText = "[ç©º]";
        document.getElementById('btnStep').innerText = "â–¶ ä¸‹ä¸€æ­¥";
    }

    function toggleAuto() {
        const btn = document.getElementById('btnAuto');
        if(autoTimer) {
            clearInterval(autoTimer);
            autoTimer = null;
            btn.innerText = "è‡ªåŠ¨";
            document.getElementById('btnStep').disabled = false;
        } else {
            btn.innerText = "æš‚åœ";
            document.getElementById('btnStep').disabled = true;
            if(stepIndex === 0) step();
            autoTimer = setInterval(() => {
                if(stepIndex < steps.length) {
                    step();
                } else {
                    toggleAuto();
                }
            }, 2500);
        }
    }

    reset();

</script>
</body>
</html>
