<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物理内存全景视图 (740px版)</title>
    <style>
        :root {
            --ram-border: #795548;
            --ram-bg: #fff3e0;
            --user-bg: #e1f5fe;
            --kernel-bg: #ffe0b2;
            --hw-bg: #263238;
            --tx-color: #2e7d32;
            --rx-color: #1565c0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 10px;
            /* 核心限制：最大宽度 740px */
            max-width: 740px;
            margin-left: auto;
            margin-right: auto;
        }

        /* 顶部控制栏 - 适配窄屏 */
        .controls {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box; /* 确保内边距不撑大 */
            display: flex;
            flex-wrap: wrap; /* 允许换行 */
            gap: 8px;
            margin-bottom: 15px;
            z-index: 1000;
            justify-content: center;
        }
        
        button {
            padding: 6px 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; font-size: 13px;
            flex-grow: 1; /* 按钮自动填满 */
        }
        .btn-tx { background: var(--tx-color); }
        .btn-rx { background: var(--rx-color); }
        .btn-step { background: #f57c00; }
        .btn-reset { background: #78909c; }
        button:disabled { background: #ddd; color: #aaa; }

        .status {
            font-family: monospace; color: #333; font-size: 12px;
            width: 100%; text-align: center; margin-top: 5px;
        }

        /* 主舞台 - 锁定宽度 */
        .stage {
            position: relative;
            width: 100%; /* 填满 740px */
            height: 700px; /* 高度适当减小 */
        }

        /* =========================================
           1. 物理内存容器
           ========================================= */
        #phys-ram {
            position: absolute;
            top: 0; left: 0; right: 0; height: 480px;
            border: 4px solid var(--ram-border);
            background: var(--ram-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(121, 85, 72, 0.15);
            overflow: hidden;
            box-sizing: border-box;
        }

        .ram-label {
            position: absolute; top: 0; left: 0;
            background: var(--ram-border); color: white;
            padding: 2px 10px; border-bottom-right-radius: 8px;
            font-weight: bold; font-size: 12px; z-index: 5;
        }

        /* 用户态区域 */
        #area-user {
            height: 140px;
            background: var(--user-bg);
            border-bottom: 2px dashed #b0bec5;
            position: relative;
        }
        .area-label {
            position: absolute; top: 5px; right: 10px;
            font-weight: bold; color: rgba(0,0,0,0.3); font-size: 12px; text-transform: uppercase;
        }

        /* 内核态区域 */
        #area-kernel {
            height: 340px;
            background: var(--kernel-bg);
            position: relative;
            display: flex;
            padding: 15px 5px; /* 减小内边距 */
            justify-content: space-around; /* 自动分配空间 */
            align-items: flex-start;
        }
        
        .boundary-text {
            position: absolute; top: 128px; left: 50%; transform: translateX(-50%);
            background: #fff; padding: 0 8px; font-size: 10px; color: #78909c;
            border-radius: 8px; border: 1px solid #b0bec5; z-index: 2;
        }

        /* 组件样式 */
        .box {
            background: white; border: 2px solid #555; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* App 在用户态内存中 - 居中 */
        #app-mem {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            width: 140px; height: 60px;
            border-color: #039be5; color: #0277bd; font-size: 13px;
        }
        .mem-addr { font-size: 9px; color: #999; position: absolute; top: 1px; left: 3px; }

        /* 内核组件布局 - 宽度自适应 */
        .k-group {
            width: 31%; /* 三个并排 */
            border: 1px dotted #8d6e63; border-radius: 8px;
            padding: 8px 4px; 
            display: flex; flex-direction: column; align-items: center;
            background: rgba(255,255,255,0.4);
            box-sizing: border-box;
        }
        .k-title { font-size: 11px; color: #5d4037; margin-bottom: 8px; font-weight: bold; text-align: center; }

        /* 协议栈代码段 */
        .stack-layer {
            width: 95%; height: 35px; border: 1px solid #aaa; background: white;
            margin-bottom: 5px; display: flex; align-items: center; justify-content: center;
            font-size: 11px; transition: all 0.2s;
        }
        .active-code { background: #fffde7; border-color: #fdd835; box-shadow: 0 0 8px #fdd835; transform: scale(1.02); }

        /* Ring Buffer */
        #ring-box {
            width: 95%; height: 140px; background: white; border: 2px solid #5d4037;
            border-radius: 4px; padding: 4px; position: relative;
        }
        .desc { height: 25px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 10px; padding-left: 2px; color: #888; overflow: hidden; white-space: nowrap; }
        .desc.active { background: #fff59d; color: #f57f17; font-weight: bold; }

        /* Socket Buffer */
        #skb-box {
            width: 95%; height: 100px; border: 2px dashed #8d6e63; background: #efebe9;
            display: flex; align-items: center; justify-content: center; font-size: 11px; color: #795548;
            text-align: center;
        }

        /* =========================================
           2. 硬件层 - 适配窄宽度
           ========================================= */
        #hardware {
            position: absolute; bottom: 10px; left: 0; right: 0; height: 160px;
            background: var(--hw-bg);
            border-radius: 12px;
            border: 3px solid #000;
            color: white;
            box-sizing: border-box;
        }
        .hw-label {
            position: absolute; top: 5px; left: 10px; font-weight: bold; font-size: 11px; color: #90a4ae;
        }

        #nic-chip {
            position: absolute; top: 35px; 
            /* 居中处理 */
            left: 50%; transform: translateX(-50%);
            width: 90%; /* 占 90% 宽度 */
            height: 90px;
            border: 2px solid #455a64; background: #37474f;
            display: flex; align-items: center; justify-content: space-around;
            border-radius: 8px;
        }
        
        #nic-sram {
            width: 35%; /* 比例宽度 */
            height: 60px;
            border: 2px solid #00e676; background: #1b5e20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; text-align: center;
        }

        #cable {
            position: absolute; top: 75px; right: -10px; width: 60px; height: 8px; background: #111;
        }

        /* 总线箭头 - 自动居中 */
        .bus-arrow {
            position: absolute; 
            left: 50%; transform: translateX(-50%); /* 居中 */
            top: 485px; height: 40px; width: 4px; background: #bbb;
        }

        /* 移动的数据包 */
        #packet {
            position: absolute;
            width: 70px; height: 36px; /* 稍微缩小 */
            background: var(--tx-color); color: white;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
            font-size: 11px; z-index: 999; opacity: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hdr { width: 12px; height: 100%; border-right: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; writing-mode: vertical-rl; font-size: 8px;}

    </style>
</head>
<body>

<div class="controls">
    <button class="btn-tx" onclick="setMode('TX')">TX 发送</button>
    <button class="btn-rx" onclick="setMode('RX')">RX 接收</button>
    <button class="btn-step" id="btn-next" onclick="next()" disabled>➡ 下一步</button>
    <button onclick="autoPlay()" style="background:#5c6bc0;">▶ 播放</button>
    <button class="btn-reset" onclick="reset()">重置</button>
    <div class="status" id="status-text">准备就绪</div>
</div>

<div class="stage">

    <!-- 1. 物理内存 (统一容器) -->
    <div id="phys-ram">
        <div class="ram-label">Physical RAM (内存条)</div>
        
        <!-- 用户态 -->
        <div id="area-user">
            <div class="area-label">User Space</div>
            <div class="box" id="app-mem">
                <span class="mem-addr">0x7F..</span>
                App Buffer
            </div>
        </div>
        
        <!-- 边界 -->
        <div class="boundary-text">Syscall (用户/内核切换)</div>

        <!-- 内核态 -->
        <div id="area-kernel">
            <!-- 代码区 -->
            <div class="k-group">
                <div class="k-title">Code (Logic)</div>
                <div class="stack-layer" id="code-tcp">TCP Logic</div>
                <div class="stack-layer" id="code-ip">IP Logic</div>
                <div class="stack-layer" id="code-mac">MAC/Driver</div>
            </div>

            <!-- 数据区 -->
            <div class="k-group">
                <div class="k-title">Data (Buffer)</div>
                <div id="skb-box">
                    <span class="mem-addr">0xFF..</span>
                    Socket Buffer<br>(sk_buff)
                </div>
            </div>

            <!-- Ring Buffer 区 -->
            <div class="k-group">
                <div class="k-title">Ring Buffer</div>
                <div id="ring-box">
                    <span class="mem-addr">0xFA..</span>
                    <div class="desc" id="desc-0">0: [Empty]</div>
                    <div class="desc" id="desc-1">1: [Empty]</div>
                    <div class="desc" id="desc-2">2: [Empty]</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 连接总线 -->
    <div class="bus-arrow"></div>
    <div style="position:absolute; left:50%; transform:translateX(10px); top:495px; font-size:10px; color:#888;">PCIe</div>

    <!-- 2. 硬件层 -->
    <div id="hardware">
        <div class="hw-label">Hardware (NIC)</div>
        
        <div id="nic-chip">
            <div style="font-size:11px;">DMA</div>
            <div style="font-size:16px; opacity:0.5;">↔</div>
            
            <!-- 网卡 SRAM -->
            <div id="nic-sram">
                <strong>On-Chip SRAM</strong><br>
                (FIFO)
            </div>
            
            <div style="font-size:16px; opacity:0.5;">↔</div>
            <div style="font-size:11px;">PHY</div>
        </div>

        <div id="cable"></div>
    </div>

    <div id="packet">Data</div>

</div>

<script>
    let mode = null;
    let step = 0;
    let running = false;
    const pkt = document.getElementById('packet');
    const status = document.getElementById('status-text');
    const btnNext = document.getElementById('btn-next');

    // 自动获取元素中心，适应740px布局
    function getCenter(id) {
        const el = document.getElementById(id);
        const rect = el.getBoundingClientRect();
        // 计算相对于 stage 的位置
        const stage = document.querySelector('.stage').getBoundingClientRect();
        return {
            x: rect.left - stage.left + rect.width/2,
            y: rect.top - stage.top + rect.height/2
        };
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function move(target, ms=800, scale=1) {
        const pos = getCenter(target);
        const w = pkt.offsetWidth;
        const h = pkt.offsetHeight;
        
        pkt.style.transition = `all ${ms}ms cubic-bezier(0.45, 0, 0.55, 1)`;
        pkt.style.left = (pos.x - w/2) + 'px';
        pkt.style.top = (pos.y - h/2) + 'px';
        pkt.style.transform = `scale(${scale})`;
        await sleep(ms);
    }

    function addHdr(txt, col) {
        const d = document.createElement('div');
        d.className = 'hdr';
        d.style.backgroundColor = col;
        d.innerText = txt;
        d.id = 'h-'+txt;
        pkt.insertBefore(d, pkt.firstChild);
        // 重置宽度以适应内容
        pkt.style.width = 'auto';
        // 最小宽度保证
        if(pkt.offsetWidth < 70) pkt.style.width = '70px';
    }

    function remHdr(txt) {
        const d = document.getElementById('h-'+txt);
        if(d) d.remove();
        if(document.querySelectorAll('.hdr').length === 0) pkt.style.width = '70px';
    }

    async function highlightCode(id) {
        const el = document.getElementById(id);
        el.classList.add('active-code');
        await sleep(500);
        el.classList.remove('active-code');
    }

    // TX Flow
    const txSteps = [
        {
            t: "1. 应用生成数据 (User RAM)",
            f: async () => {
                const p = getCenter('app-mem');
                pkt.style.transition='none';
                pkt.style.left = (p.x-35)+'px'; pkt.style.top = (p.y-18)+'px';
                pkt.style.opacity=1; pkt.style.background='var(--tx-color)';
                pkt.innerHTML='Data';
            }
        },
        {
            t: "2. Copy to Kernel (内存内复制)",
            f: async () => { await move('skb-box'); }
        },
        {
            t: "3. TCP 协议处理 (Logic)",
            f: async () => { await highlightCode('code-tcp'); addHdr('T', '#42a5f5'); }
        },
        {
            t: "4. IP 协议处理 (Logic)",
            f: async () => { await highlightCode('code-ip'); addHdr('I', '#ffa726'); }
        },
        {
            t: "5. MAC/Driver (Logic)",
            f: async () => { await highlightCode('code-mac'); addHdr('M', '#ab47bc'); }
        },
        {
            t: "6. 更新 Ring Buffer (指针)",
            f: async () => {
                const d = document.getElementById('desc-1');
                d.classList.add('active');
                d.innerText = "1: [Ready]";
                await sleep(400);
            }
        },
        {
            t: "7. DMA: RAM -> NIC SRAM",
            f: async () => {
                await move('nic-sram', 1500, 0.8);
                document.getElementById('desc-1').classList.remove('active');
                document.getElementById('desc-1').innerText = "1: [Done]";
            }
        },
        {
            t: "8. 发送信号",
            f: async () => {
                const cab = getCenter('cable');
                pkt.innerHTML=''; pkt.style.width='10px'; pkt.style.height='10px'; pkt.style.borderRadius='50%';
                pkt.style.transition='all 0.5s linear';
                pkt.style.left = (cab.x+30)+'px';
                pkt.style.top = cab.y+'px';
                pkt.style.opacity=0;
                await sleep(500);
            }
        }
    ];

    // RX Flow
    const rxSteps = [
        {
            t: "1. 信号到达 -> NIC SRAM",
            f: async () => {
                const cab = getCenter('cable');
                pkt.innerHTML=''; pkt.style.width='10px'; pkt.style.height='10px'; pkt.style.borderRadius='50%';
                pkt.style.background='var(--rx-color)'; pkt.style.opacity=1;
                pkt.style.transition='none';
                pkt.style.left = (cab.x+30)+'px'; pkt.style.top = cab.y+'px';
                
                await move('nic-sram', 600, 0.8);
            }
        },
        {
            t: "2. 缓冲重组帧",
            f: async () => {
                pkt.style.width='auto'; pkt.style.height='36px'; pkt.style.borderRadius='4px';
                pkt.innerHTML='Data';
                addHdr('T', '#42a5f5'); addHdr('I', '#ffa726'); addHdr('M', '#ab47bc');
                await sleep(300);
            }
        },
        {
            t: "3. DMA: NIC -> Kernel RAM",
            f: async () => {
                const d = document.getElementById('desc-2');
                d.innerText = "2: [RX Busy]"; d.classList.add('active');
                await move('skb-box', 1500, 1);
                d.classList.remove('active'); d.innerText = "2: [Recv]";
            }
        },
        {
            t: "4. MAC 处理 (去除头部)",
            f: async () => { await highlightCode('code-mac'); remHdr('M'); }
        },
        {
            t: "5. IP 处理",
            f: async () => { await highlightCode('code-ip'); remHdr('I'); }
        },
        {
            t: "6. TCP 处理",
            f: async () => { await highlightCode('code-tcp'); remHdr('T'); }
        },
        {
            t: "7. Copy to User (Recv)",
            f: async () => {
                await move('app-mem');
                pkt.innerHTML = "OK";
            }
        }
    ];

    function reset() {
        running = false; step = 0; mode = null;
        pkt.style.opacity=0; pkt.style.transition='none';
        pkt.innerHTML='Data';
        const hs = document.querySelectorAll('.hdr'); hs.forEach(h=>h.remove());
        document.querySelectorAll('.desc').forEach((d,i)=> {d.className='desc'; d.innerText=i+': [Empty]'});
        status.innerText = "已重置";
        btnNext.disabled = true;
    }

    function setMode(m) {
        reset(); mode = m;
        const total = m==='TX'?txSteps.length:rxSteps.length;
        status.innerText = `模式: ${m} | 步骤: 0/${total}`;
        btnNext.disabled = false;
    }

    async function next() {
        if(running || !mode) return;
        running = true; btnNext.disabled = true;
        const flow = mode==='TX'?txSteps:rxSteps;
        if(step < flow.length) {
            status.innerText = flow[step].t;
            await flow[step].f();
            step++;
            btnNext.disabled = false;
        } else {
            status.innerText = "流程结束";
        }
        running = false;
    }

    async function autoPlay() {
        if(!mode) return alert("请先选择模式");
        while(step < (mode==='TX'?txSteps.length:rxSteps.length)) {
            await next();
            await sleep(500);
        }
    }
</script>

</body>
</html>