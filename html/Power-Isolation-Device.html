<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µåŠ›éš”ç¦»è£…ç½®ä»¿çœŸ</title>
    <style>
        :root {
            --primary: #096dd9;
            --vip-color: #d46b08;
            --safe: #389e0d;
            --danger: #cf1322;
            --bg: #f5f7fa;
            --panel: #ffffff;
            --border: #d9d9d9;
        }

        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1360px; margin: 0 auto; }
        
        /* ================= 1. é…ç½®é¢æ¿ ================= */
        .config-panel {
            background: var(--panel); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: grid; grid-template-columns: 1fr 1px 1fr; gap: 30px; margin-bottom: 20px;
        }
        .divider { background: #eee; height: 100%; }
        
        .cfg-group-title { font-weight: bold; border-left: 4px solid; padding-left: 10px; margin-bottom: 15px; font-size: 1.1em; }
        .title-in { border-color: var(--danger); color: var(--danger); }
        .title-out { border-color: var(--safe); color: var(--safe); }

        .input-row { display: flex; align-items: center; margin-bottom: 10px; }
        .input-row label { width: 100px; font-size: 13px; color: #666; text-align: right; margin-right: 10px; }
        .input-row input { 
            flex: 1; padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; 
            font-family: monospace; font-weight: bold; transition: all 0.3s;
        }
        .input-row input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(24,144,255,0.2); }
        .input-vip { border-color: var(--vip-color); background: #fff7e6; color: var(--vip-color); }
        .input-err { border-color: var(--danger) !important; background: #fff1f0 !important; }
        
        .status-msg { margin-left: 110px; font-size: 12px; font-weight: bold; height: 20px; }
        .msg-ok { color: var(--safe); }
        .msg-err { color: var(--danger); }

        /* ================= 2. æ‹“æ‰‘èˆå° ================= */
        .stage {
            position: relative; height: 500px; background: var(--panel); border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden; border: 1px solid #e8e8e8;
        }

        /* åŒºåŸŸèƒŒæ™¯ */
        .zone-layer { position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; z-index: 0; }
        .zone-in { position: absolute; left: 0; width: 50%; height: 100%; background: rgba(255, 241, 240, 0.4); border-right: 2px dashed #ffa39e; }
        .zone-out { position: absolute; right: 0; width: 50%; height: 100%; background: rgba(246, 255, 237, 0.4); }
        .zone-badge { position: absolute; top: 10px; padding: 4px 12px; font-size: 12px; font-weight: bold; border-radius: 15px; border: 1px solid; background: white; z-index: 1;}

        /* è®¾å¤‡èŠ‚ç‚¹æ ·å¼ */
        .node { position: absolute; width: 110px; text-align: center; z-index: 10; padding: 10px; background:transparent; }
        .node-icon { font-size: 36px; display: block; margin-bottom: 5px; }
        .node-name { font-size: 12px; font-weight: bold; }
        .node-ip { font-size: 10px; font-family: monospace; background: #eee; padding: 2px; border-radius: 3px; display: inline-block;}
        .mac-pill { background: #333; color: #fff; padding: 1px 4px; font-size: 9px; border-radius: 2px; margin-bottom: 2px; display: inline-block; }

        /* äº¤æ¢æœº */
        .switch {
            position: absolute; width: 140px; height: 64px; background: #003a8c; color: white; border-radius: 6px; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .sw-ports { display: flex; gap: 8px; margin-top: 5px; }
        .port { width: 10px; height: 10px; background: #000; border: 1px solid #666; }
        .anchor { position: absolute; width: 1px; height: 1px; visibility: hidden; }

        /* éš”ç¦»è£…ç½® */
        .gap-device {
            position: absolute; left: 50%; top: 160px; transform: translateX(-50%); width: 260px; height: 130px;
            background: #262626; border-radius: 8px; z-index: 10; display: flex; justify-content: space-between; padding: 12px; color: white;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .gap-nic { display: flex; flex-direction: column; align-items: center; justify-content: space-between; width: 50px; }
        .gap-mid { flex: 1; display: flex; align-items: center; justify-content: center; border-left: 2px dashed #fadb14; border-right: 2px dashed #fadb14; margin: 0 10px; }
        
        .port-circle { width: 14px; height: 14px; background: #52c41a; border-radius: 50%; border: 2px solid #333; margin-bottom: 5px; box-shadow: 0 0 5px rgba(0,255,0,0.5); }
        .port-circle.active { background: #ffff00; box-shadow: 0 0 10px #ffff00; transform: scale(1.2); transition: 0.2s; }

        /* MACè¡¨ (æ‚¬æµ®) */
        .mac-table {
            position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 5px; width: 120px; z-index: 5;
            font-size: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .mac-table td { border-bottom: 1px solid #f0f0f0; padding: 2px; text-align: center; }

        /* è¿çº¿å±‚ (SVG) */
        .svg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .cable { stroke: #999; stroke-width: 3; fill: none; stroke-linecap: round; }

        /* æ•°æ®åŒ… */
        .packet {
            position: absolute; width: 150px; background: #fff; border: 2px solid var(--primary); border-radius: 4px; z-index: 20;
            font-size: 10px; font-family: monospace; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .pkt-l2 { background: #e6f7ff; padding: 2px 5px; border-bottom: 1px solid #eee; color: #666; display: flex; justify-content: space-between; }
        .pkt-l3 { padding: 4px 5px; color: var(--primary); font-weight: bold; text-align: center; }
        
        .packet.stripped {
            width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--primary);
            display: flex; align-items: center; justify-content: center; padding: 0;
            background: #fff; color: #333; font-weight: bold;
        }
        .packet.stripped .pkt-l2, .packet.stripped .pkt-l3 { display: none; }
        .packet.stripped::after { content: "Data"; font-size: 10px; }

        /* æ§åˆ¶åŒºåŸŸ */
        .controls { display: grid; grid-template-columns: 200px 1fr; gap: 20px; margin-top: 20px; }
        .btn-stack { display: flex; flex-direction: column; gap: 10px; }
        button { padding: 12px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .btn-run { background: var(--primary); color: white; }
        .btn-step { background: #faad14; color: white; }
        .btn-reset { background: #d9d9d9; color: #333; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { filter: brightness(1.1); }

        .log-box {
            background: #262626; color: #a0d911; font-family: Consolas, monospace; padding: 15px;
            border-radius: 6px; height: 150px; overflow-y: auto; font-size: 13px; line-height: 1.5;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">ç”µåŠ›éš”ç¦»è£…ç½®ä»¿çœŸ</h2>

    <!-- é…ç½®åŒºåŸŸ -->
    <div class="config-panel">
        <div>
            <div class="cfg-group-title title-in">å†…ç½‘åŒº (IåŒº)</div>
            <div class="input-row"><label>å­ç½‘æ©ç </label><input type="text" id="mask_in" value="255.255.255.0" oninput="validate()"></div>
            <div class="input-row"><label>ä¸»æœº IP</label><input type="text" id="ip_host" value="192.168.1.100" oninput="validate()"></div>
            <div class="input-row"><label>è£…ç½® VIP</label><input type="text" id="ip_vip" value="192.168.1.254" class="input-vip" oninput="validate()"></div>
            <div class="status-msg" id="msg_in">...</div>
        </div>

        <div class="divider"></div>

        <div>
            <div class="cfg-group-title title-out">å¤–ç½‘åŒº (IIIåŒº)</div>
            <div class="input-row"><label>å­ç½‘æ©ç </label><input type="text" id="mask_out" value="255.255.255.0" oninput="validate()"></div>
            <div class="input-row"><label>è£…ç½®å¤–ç½‘ IP</label><input type="text" id="ip_gap_out" value="10.20.30.1" oninput="validate()"></div>
            <div class="input-row"><label>æœåŠ¡å™¨ IP</label><input type="text" id="ip_server" value="10.20.30.200" oninput="validate()"></div>
            <div class="status-msg" id="msg_out">...</div>
        </div>
    </div>

    <!-- èˆå°åŒºåŸŸ -->
    <div class="stage" id="stage">
        <div class="zone-layer">
            <div class="zone-in"><div class="zone-badge" style="left:20px; color:#cf1322;">å†…ç½‘ Broadcast Domain</div></div>
            <div class="zone-out"><div class="zone-badge" style="right:20px; color:#389e0d;">å¤–ç½‘ Broadcast Domain</div></div>
        </div>

        <svg class="svg-container">
            <path id="line_host_sw1" class="cable" />
            <path id="line_sw1_gap" class="cable" />
            <path id="line_gap_sw2" class="cable" />
            <path id="line_sw2_srv" class="cable" />
        </svg>

        <div class="node" id="host" style="left:50px; top:120px;">
            <div class="node-icon">ğŸ’»</div><div class="node-name">SCADAä¸»æœº</div>
            <div class="mac-pill">AA:AA:AA:AA</div><div class="node-ip" id="d_ip_host">192.168.1.100</div>
            <div id="anchor_host" class="anchor" style="left:50%; top:100%;"></div>
        </div>

        <div class="switch" id="sw1" style="left:200px; top:320px;">
            <div class="node-name">å†…ç½‘äº¤æ¢æœº</div>
            <div class="sw-ports"><div class="port"></div><div class="port"></div><div class="port"></div><div class="port"></div></div>
            <div id="anchor_sw1_left" class="anchor" style="left:20%; top:0;"></div>
            <div id="anchor_sw1_right" class="anchor" style="left:80%; top:0;"></div>
        </div>
        
        <div class="mac-table" id="t_sw1" style="left:210px; top:400px;">
            <div style="background:#f0f0f0; text-align:center;">SW1 MACè¡¨</div>
            <table width="100%"><tbody id="tb_sw1"></tbody></table>
        </div>

        <div class="gap-device" id="gap">
            <div class="gap-nic">
                <div class="port-circle" id="p_gap_in"></div><div class="mac-pill">BB:BB:BB:BB</div>
                <div class="node-ip" id="d_ip_vip" style="color:var(--vip-color); font-weight:bold;">VIP</div>
                <div id="anchor_gap_in" class="anchor" style="left:50%; top:100%;"></div>
            </div>
            <div class="gap-mid">âš¡ ç‰©ç†éš”ç¦» âš¡</div>
            <div class="gap-nic">
                <div class="port-circle" id="p_gap_out"></div><div class="mac-pill">CC:CC:CC:CC</div>
                <div class="node-ip" id="d_ip_gap_out">...</div>
                <div id="anchor_gap_out" class="anchor" style="left:50%; top:100%;"></div>
            </div>
        </div>

        <div class="switch" id="sw2" style="right:200px; top:320px; background:#0050b3;">
            <div class="node-name">å¤–ç½‘äº¤æ¢æœº</div>
            <div class="sw-ports"><div class="port"></div><div class="port"></div><div class="port"></div><div class="port"></div></div>
            <div id="anchor_sw2_left" class="anchor" style="left:20%; top:0;"></div>
            <div id="anchor_sw2_right" class="anchor" style="left:80%; top:0;"></div>
        </div>

        <div class="mac-table" id="t_sw2" style="right:210px; top:400px;">
            <div style="background:#f0f0f0; text-align:center;">SW2 MACè¡¨</div>
            <table width="100%"><tbody id="tb_sw2"></tbody></table>
        </div>

        <div class="node" id="server" style="right:50px; top:120px;">
            <div class="node-icon">ğŸ—„ï¸</div><div class="node-name">MISæœåŠ¡å™¨</div>
            <div class="mac-pill">DD:DD:DD:DD</div><div class="node-ip" id="d_ip_server">...</div>
            <div id="anchor_server" class="anchor" style="left:50%; top:100%;"></div>
        </div>

        <div id="packet" class="packet">
            <div class="pkt-l2"><span>M_Src:<b id="pk_sm">AA</b></span><span>M_Dst:<b id="pk_dm">BB</b></span></div>
            <div class="pkt-l3">Src: <span id="pk_sip">...</span><br>Dst: <span id="pk_dip">...</span></div>
        </div>
    </div>

    <div class="controls">
        <div class="btn-stack">
            <button class="btn-run" id="btnStart" onclick="initSim()" disabled>â–¶ åˆå§‹åŒ–</button>
            <button class="btn-step" id="btnNext" onclick="nextStep()" disabled>ğŸ‘£ å•æ­¥æ‰§è¡Œ</button>
            <button class="btn-reset" onclick="location.reload()">â†º åˆ·æ–°é‡ç½®</button>
        </div>
        <div class="log-box" id="logger">
            <div>ç³»ç»Ÿå°±ç»ªã€‚è¯·ä¿®æ”¹ä¸Šæ–¹é…ç½® IPï¼Œé€šè¿‡æ ¡éªŒåç‚¹å‡»â€œåˆå§‹åŒ–â€ã€‚</div>
        </div>
    </div>
</div>

<script>
    const MACs = { host: 'AA:AA', vip: 'BB:BB', gapOut: 'CC:CC', server: 'DD:DD' };
    let step = 0;
    let config = {};

    function drawLines() {
        const stage = document.getElementById('stage').getBoundingClientRect();
        function getAnchor(id) {
            const el = document.getElementById(id).getBoundingClientRect();
            return { x: el.left - stage.left, y: el.top - stage.top };
        }
        function setLine(lineId, p1, p2) {
            document.getElementById(lineId).setAttribute('d', `M ${p1.x} ${p1.y} L ${p1.x} ${p1.y + 30} L ${p2.x} ${p2.y - 30} L ${p2.x} ${p2.y}`);
        }
        setLine('line_host_sw1', getAnchor('anchor_host'), getAnchor('anchor_sw1_left'));
        setLine('line_sw1_gap', getAnchor('anchor_sw1_right'), getAnchor('p_gap_in'));
        setLine('line_gap_sw2', getAnchor('p_gap_out'), getAnchor('anchor_sw2_left'));
        setLine('line_sw2_srv', getAnchor('anchor_sw2_right'), getAnchor('anchor_server'));
    }
    window.onload = drawLines; window.onresize = drawLines;

    function ip2int(ip) { return ip.split('.').reduce((acc, val) => (acc << 8) + parseInt(val), 0) >>> 0; }

    function validate() {
        const els = {
            m_in: document.getElementById('mask_in'), ip_h: document.getElementById('ip_host'), ip_v: document.getElementById('ip_vip'),
            m_out: document.getElementById('mask_out'), ip_g: document.getElementById('ip_gap_out'), ip_s: document.getElementById('ip_server'),
            msg_in: document.getElementById('msg_in'), msg_out: document.getElementById('msg_out'), btn: document.getElementById('btnStart')
        };
        document.getElementById('d_ip_host').innerText = els.ip_h.value;
        document.getElementById('d_ip_vip').innerText = "VIP: " + els.ip_v.value;
        document.getElementById('d_ip_gap_out').innerText = els.ip_g.value;
        document.getElementById('d_ip_server').innerText = els.ip_s.value;

        let okIn = false, okOut = false;
        try { if ((ip2int(els.ip_h.value) & ip2int(els.m_in.value)) === (ip2int(els.ip_v.value) & ip2int(els.m_in.value))) okIn = true; } catch(e){}
        try { if ((ip2int(els.ip_g.value) & ip2int(els.m_out.value)) === (ip2int(els.ip_s.value) & ip2int(els.m_out.value))) okOut = true; } catch(e){}

        els.msg_in.innerHTML = okIn ? "<span class='msg-ok'>âœ” L2æ­£å¸¸</span>" : "<span class='msg-err'>âœ˜ ç½‘æ®µé”™è¯¯</span>";
        els.msg_out.innerHTML = okOut ? "<span class='msg-ok'>âœ” L2æ­£å¸¸</span>" : "<span class='msg-err'>âœ˜ ç½‘æ®µé”™è¯¯</span>";
        
        els.btn.disabled = !(okIn && okOut);
        config = { srcIp: els.ip_h.value, vip: els.ip_v.value, gapIp: els.ip_g.value, dstIp: els.ip_s.value };
    }

    function log(msg) {
        const div = document.createElement('div'); div.innerHTML = `> ${msg}`;
        const box = document.getElementById('logger'); box.appendChild(div); box.scrollTop = box.scrollHeight;
    }

    function initSim() {
        step = 1;
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnNext').disabled = false;
        document.getElementById('btnNext').innerHTML = "ğŸ‘£ å•æ­¥æ‰§è¡Œ (1/7)";
        
        // --- ä¿®å¤å…³é”®ç‚¹ï¼šæ¸…ç©ºæ—§è¡¨ ---
        document.getElementById('tb_sw1').innerHTML = '';
        document.getElementById('tb_sw2').innerHTML = '';
        document.getElementById('logger').innerHTML = ''; // å¯é€‰ï¼šæ¸…ç©ºæ—¥å¿—

        log("ä»¿çœŸåˆå§‹åŒ–å®Œæˆã€‚è¡¨æ ¼å·²æ¸…ç©ºã€‚ä¸»æœºå‡†å¤‡å‘é€æ•°æ®ã€‚");
        
        const pkt = document.getElementById('packet');
        pkt.style.display = 'block'; pkt.classList.remove('stripped');
        
        // Reset Position
        const hostRect = document.getElementById('host').getBoundingClientRect();
        const stageRect = document.getElementById('stage').getBoundingClientRect();
        pkt.style.left = (hostRect.left - stageRect.left + 20) + 'px';
        pkt.style.top = (hostRect.top - stageRect.top + 20) + 'px';

        updatePacketInfo(MACs.host, MACs.vip, config.srcIp, config.vip);
        drawLines();
    }

    function updatePacketInfo(sm, dm, sip, dip) {
        document.getElementById('pk_sm').innerText = sm; document.getElementById('pk_dm').innerText = dm;
        document.getElementById('pk_sip').innerText = sip; document.getElementById('pk_dip').innerText = dip;
    }

    async function nextStep() {
        const btn = document.getElementById('btnNext'); btn.disabled = true;
        switch(step) {
            case 1: 
                log(`[ä¸»æœº] ARPè§£æVIP(${config.vip})æˆåŠŸã€‚å‘é€è‡³ SW1ã€‚`);
                await movePacket('anchor_host', 'anchor_sw1_left'); break;
            case 2: 
                log(`[SW1] å­¦ä¹ MAC ${MACs.host}ã€‚è½¬å‘è‡³éš”ç¦»è£…ç½®ã€‚`);
                addMac('tb_sw1', MACs.host, 'P_Host'); await wait(500);
                addMac('tb_sw1', MACs.vip, 'P_Gap'); break;
            case 3: await movePacket('anchor_sw1_right', 'p_gap_in'); break;
            case 4: 
                log(`[éš”ç¦»è£…ç½®] æ”¶åˆ°ã€‚æ£€æµ‹ç›®çš„VIPåŒ¹é…ã€‚`);
                document.getElementById('p_gap_in').classList.add('active'); await wait(500);
                log(`<span style="color:#cf1322">>> åè®®å‰¥ç¦»ï¼šä¸¢å¼ƒå¤´ä¿¡æ¯ã€‚</span>`);
                document.getElementById('packet').classList.add('stripped'); await wait(500);
                await movePacket('p_gap_in', 'p_gap_out'); document.getElementById('p_gap_in').classList.remove('active'); break;
            case 5: 
                document.getElementById('p_gap_out').classList.add('active');
                log(`[éš”ç¦»è£…ç½®] é‡ç»„ã€‚SrcIP=${config.gapIp}, DstIP=${config.dstIp}`);
                document.getElementById('packet').classList.remove('stripped');
                updatePacketInfo(MACs.gapOut, MACs.server, config.gapIp, config.dstIp); await wait(1000);
                await movePacket('p_gap_out', 'anchor_sw2_left'); document.getElementById('p_gap_out').classList.remove('active'); break;
            case 6: 
                log(`[SW2] å­¦ä¹ MAC ${MACs.gapOut}ã€‚è½¬å‘è‡³æœåŠ¡å™¨ã€‚`);
                addMac('tb_sw2', MACs.gapOut, 'P_Gap'); break;
            case 7: 
                await movePacket('anchor_sw2_right', 'anchor_server');
                log("æ•°æ®åˆ°è¾¾æœåŠ¡å™¨ã€‚æ¼”ç¤ºæˆåŠŸï¼");
                document.getElementById('packet').style.display = 'none';
                document.getElementById('btnStart').disabled = false; btn.innerHTML = "æ¼”ç¤ºç»“æŸ"; return;
        }
        step++; btn.disabled = false; btn.innerHTML = `ğŸ‘£ å•æ­¥æ‰§è¡Œ (${step}/7)`;
    }

    function movePacket(startId, endId) {
        return new Promise(resolve => {
            const sRect = document.getElementById(startId).getBoundingClientRect();
            const eRect = document.getElementById(endId).getBoundingClientRect();
            const stageRect = document.getElementById('stage').getBoundingClientRect();
            const pkt = document.getElementById('packet');
            const x = eRect.left - stageRect.left - (pkt.offsetWidth/2 - eRect.width/2); // Center alignment fix might need adjustment based on anchor type
            const y = eRect.top - stageRect.top - (pkt.offsetHeight/2 - eRect.height/2);
            pkt.style.transition = 'all 1s ease-in-out'; pkt.style.left = (eRect.left - stageRect.left - 20) + 'px'; pkt.style.top = (eRect.top - stageRect.top - 20) + 'px'; // Simplified target
            setTimeout(() => { pkt.style.transition = ''; resolve(); }, 1000);
        });
    }

    // --- ä¿®å¤å…³é”®ç‚¹ï¼šaddMac æŸ¥é‡é€»è¾‘ ---
    function addMac(tbId, mac, port) {
        const tbody = document.getElementById(tbId);
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const rows = tbody.getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            if (rows[i].cells[0].innerText === mac) {
                // å¦‚æœå­˜åœ¨ï¼Œå¯ä»¥é€‰æ‹©é—ªçƒä¸€ä¸‹è¡¨ç¤ºåˆ·æ–°ï¼Œæˆ–è€…ç›´æ¥è¿”å›
                return; 
            }
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${mac}</td><td>${port}</td>`;
        tr.style.background = '#e6f7ff';
        tbody.appendChild(tr);
    }

    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
    validate();
</script>

</body>
</html>
